Api Management Landing Page + Backend (express + Drizzle)
· typescript
// =============================================
rt.get("/api/doc-audit", async (req,res)=>{
  const { q, user, from, to, docId, limit=100 } = req.query as any;
  let query = db.select().from(docAudit).orderBy(desc(docAudit.createdAt)).limit(Number(limit));
  const wheres:any[] = [];
  if(docId) wheres.push(eq(docAudit.documentId,docId));
  if(user) wheres.push(eq(docAudit.userId,user));
  if(from) wheres.push(gte(docAudit.createdAt,new Date(from)));
  if(to) wheres.push(lte(docAudit.createdAt,new Date(to)));
  if(q) wheres.push(like(docAudit.action,`%${q}%`));
  if(wheres.length) query = query.where(and(...wheres));
  const items = await query;
  res.json({ items });
});


// =============================================
// FRONTEND: usage in Document detail page
// Example: inside DocumentDetail.tsx tabs
// <TabsContent value="audit"><DocumentAuditTab documentId={doc.id}/></TabsContent>




// =============================================
// BACKEND: Export audit logs as CSV
// File: server/routes/docAudit.ts (extend)
import { Parser } from "json2csv";


rt.get("/api/doc-audit/export.csv", async (req,res)=>{
  const { docId, limit=1000 } = req.query as any;
  let query = db.select().from(docAudit).orderBy(desc(docAudit.createdAt)).limit(Number(limit));
  if(docId) query = query.where(eq(docAudit.documentId,docId));
  const items = await query;
  const parser = new Parser({ fields:["id","documentId","userId","action","ip","userAgent","createdAt"] });
  const csv = parser.parse(items);
  res.header("Content-Type","text/csv");
  res.attachment("doc-audit.csv");
  res.send(csv);
});


// =============================================
// FRONTEND: Export button on Audit page
// File: client/src/pages/family/doc-audit.tsx (add near header)
<Button asChild variant="outline" className="border-yellow-500/30 text-yellow-400 ml-2">
  <a href="/api/doc-audit/export.csv" target="_blank">Export CSV</a>
</Button>


// =============================================
// OPTIONAL: Export PDF (using server-side pdfkit or reportlab)
// Could add a route /api/doc-audit/export.pdf later if needed for compliance.




// =============================================
// BACKEND: Export audit logs as PDF
// File: server/routes/docAudit.ts (extend)
import PDFDocument from "pdfkit";


rt.get("/api/doc-audit/export.pdf", async (req,res)=>{
  const { docId, limit=500 } = req.query as any;
  let query = db.select().from(docAudit).orderBy(desc(docAudit.createdAt)).limit(Number(limit));
  if(docId) query = query.where(eq(docAudit.documentId,docId));
  const items = await query;


  const doc = new PDFDocument({ margin:40, size:"A4" });
  res.setHeader("Content-Type","application/pdf");
  res.setHeader("Content-Disposition","attachment; filename=doc-audit.pdf");
  doc.pipe(res);


  doc.fontSize(18).fill

Done. I added a low-friction Upload Center flow that matches your UI and avoids annoying approvals:

What you now have (in the canvas)

Direct-to-R2/S3 uploads via a presigned POST (fast + reliable).

DB record is created up-front with virusStatus: 'pending' so owners can see/share right away.

No approval required by default (optional checkbox can create an approval later if you want).

Mobile Upload just triggers the same file input; phones open camera/file picker.

Files added

Backend

server/lib/storage.ts → presigned POST helper for R2/S3.

server/routes/uploads.ts

POST /api/uploads/create → returns presigned form + creates placeholder document.

POST /api/uploads/complete → marks upload complete (good for activity feed).

Frontend

client/src/components/upload/UploadCenter.tsx → drop-in component wired to the API.

Snippet to mount <UploadCenter /> in your Upload Center section.

Behavior

Accepts: PDF, DOC, DOCX, TXT, and images.

Size cap: 25MB (matches your UI).

After S3 returns 204, the client calls /complete, then shows “Uploaded! You can now share it.”