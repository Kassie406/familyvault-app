// server/routes/ai-agent.ts
import express from 'express';
import axios from 'axios';

const router = express.Router();
const MCP_SERVER = 'https://3eb6ec39-b907-4c70-9a5b-e192bacee3ba-00-1739ki91gyn4k.kirk.replit.dev/mcp';

// In-memory session store (replace with Redis for production)
const chatMemory: Record<string, { prompt: string; method: string }[]> = {};

function inferIntent(prompt: string): { method: string; params: any } {
  const lower = prompt.toLowerCase();

  if (lower.includes('task')) {
    return {
      method: 'manage_design_tasks',
      params: {
        project: 'FamilyVault AI',
        task: prompt,
        priority: 'High',
        assigned_to: 'UI Team',
      },
    };
  }

  if (lower.includes('audit') || lower.includes('design system')) {
    return {
      method: 'audit_design_system',
      params: {
        scope: 'full',
        note: prompt,
      },
    };
  }

  if (lower.includes('add') && lower.includes('member')) {
    return {
      method: 'add_family_member',
      params: {
        name: 'Sarah',
        role: 'guardian',
      },
    };
  }

  return {
    method: 'track_project_progress',
    params: { project: 'FamilyVault AI' },
  };
}

router.post('/ask', async (req, res) => {
  const { prompt } = req.body;
  const sessionId = req.sessionID || 'anonymous'; // Fallback if no session

  if (!prompt) return res.status(400).json({ error: 'Prompt required' });

  const history = chatMemory[sessionId] || [];
  const { method, params } = inferIntent(prompt);

  try {
    const mcpRes = await axios.post(
      MCP_SERVER,
      { method, params },
      { withCredentials: true }
    );

    // Save context
    chatMemory[sessionId] = [
      ...history.slice(-4), // keep last 4
      { prompt, method },
    ];

    const responseMsg = `
‚úÖ Executed **${method}**
üìù Prompt: ${prompt}
üì¶ MCP Response: ${JSON.stringify(mcpRes.data, null, 2)}
`;

    return res.json({ response: responseMsg });
  } catch (err: any) {
    console.error('[MCP_ERROR]', err.message);
    return res.status(500).json({ error: 'MCP request failed' });
  }
});

export default router;
